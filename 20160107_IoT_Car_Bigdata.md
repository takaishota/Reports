20160107 【IoT×車×ビッグデータ】IoT入門：デバイスとスマホを繋ぐ~プロトタイピングから製品化まで~
---
# スマホとデバイスをつなぐHow To（アプリ）
* 遅れてしまい、聞けませんでした、、、

# プロトタイピングから製品化へのHowto（ハード、ファームウェア）
## なぜ、iOSデベロッパーの方が多いか？
* ハードウェアもソフトウェアも一括で作っていてフィードバックの窓口が1つだからだと思う
  -> 同じようにアクサ損保と一緒にやるときにはハードとソフトどちらもやることにした

## プロトタイプとの違い
* 製造コストが大事
* 量産するため、一つのミスで大きな損失  
  ハードの回収があると利益がなくなるので絶対になくさないといけない

## 製品企画
* 企画したものを具現化するというところが一番重要
* マーケティングが大事

## 量産を見据えたプロトタイピング開発
* 量産時に使用する部品が仕様を満たせるか機能検証を行う
  * 要求仕様の作成
  * パートナー会社の決定
  * マイコンの評価ボードを使っての試作開発
  * ユニット単位での機能評価
  * 試作基板開発

## 量産開発
* 完成度をあげて必要な認証を取得する
  * 基板開発（小型化、部品見直し）
  * ケース開発（3Dデータ、金型）
    * 意外にここが時間がかかった
    * 顧客に見せるときに間に合わなかったので100台だけ3Dプリンタで作ったが、仕上げが悪かったので徹夜でヤスリをかけた
  * 部材調達及び価格交渉（工場、商社）
  * スケジュール調整
  * 認証の取得(TELECなど)
  * 検査用SW及び治具の開発

## 量産後
* 量産後にもメンテナンスが必要
  * コスト削減
  * 部材の製造中止対応
  * 顧客サポート
  * 不具合回収及び機能追加
  * 顧客要望によるカスタマイズ
  など

## 開発で大変だったポイント
* 車種ごとに動作が異なる（警告灯がついたり、バッテリー上がりなど）
* 対応車種の調査
* セキュリティ対策のため、外側からは物理的にアップデートできないようにした
* 量産コストUP（デザインにこると高くなったりするので、デザイナーと議論したり）
* マイコンのパフォーマンス不足
* 登場プレーヤーが多い（スケジュール管理が大変）

### 量産開発時のプレーヤー
* ビジネス開発
* デバイス開発
* スマフォアプリ開発
* サーバエンジニア
* デザイナー
* 開発パートナー

## まとめ
* 登場するプレーヤーが多いのでコミュニケーションと計画が大切
* 量産時にHW回収があるとコスト大なので注意
* スタートアップでもHWとSW一括でサービスを開発することは可能

# ドライブデータのつくりかたHowTo（サーバサイド）

## ドライブデータとは？
* ユーザごとの走行データ
* 出発地〜目的地の間でデータ
* 移動距離、速度、急加速、急停止、アイドリング時間などから運転診断をしている

* 毎秒の車両データを取得
* サーバでデータをつなぎ合わせてドライブデータを生成

## アップロードデータ
* 取得するデータは大きく2つ
  * デバイスからの車両情報
  * スマフォのセンサー系の情報

## アップロードデータの特徴
* デバイス、スマフォそれぞれ別々のタイミングでサーバへアップ
* 時系列にデータがアップされる保証がない
* 通信状況やデバイスの状況でデータが前後する
* 連続したデータが集まることで意味を持つ
  * 1つ1つのデータだけでは意味がない
* サーバ構成
  * 全てAWS
  * アプリケーションサーバ -> ローデータは全てDBに  
  -> 定期的にWorkerが動く -> IDごとにデータの計算を行う  
  -> 計算結果をDBに格納

  * APIサーバ：Rails
  * 解析処理：Node.js、Promise
  * DataStore：Amazon RDS for MySQL

### データの特徴
* デバイスとスマホの2種類のデータ
  * 別々にアップされる
  * タイムスタンプを見て同じドライブのデータかどうか判定
* 無効なデータのフィルタリング処理、有効値による補完処理
* 解析
  * 後からデータがアップされることを考慮
  * タイムスタンプが閾値ないのデータをグルーピングして計算処理
  * 処理済みのデータに後からアップされたデータを追加
  * 全体を再処理する

## ドライブデータの生成
* 実際に走行してわかることが多い
  * データが後からアップされるケースなども実際に走行して判明した
* データのフィルタリングはなるべくサーバ側で行う
  * スマホ側で行うと問題があったときの特定が難しくなる
* テストがしづらい
  * 実際の走行ログからテストを実施
  * 全てのケースを網羅するのが難しい
* バグ解析
  * 原因箇所の切り分けが難しい
  * 再現が難しい

## 今後試してみたいこと
* アーキテクチャ
  * サーバレスな構成へ
    * AWS Lambda
    * API Gateway
* リアルタイム性の向上
    * Amazon Kinesis
* 解析処理
    * スマホデータのみの運転診断もできるようにしたい

# 質疑応答
* IoTのビジネスを考えるときにどういうデータを取るかということをどういう風に決めたか
  * 最初からどのデータを取ればいいか、取れるかはわからないので試しながら、決めて行った  
    今でもこういうデータが取りたいというのはあって、追加していきたい

* 通信はどうしてスマホ経由とOBDから直接の2通りにしたか
  * BlueTooth+スマホだと費用が抑えられる
  * ただ、OBDのデータの方が正確

* DBにあえて、RDBを使い、NoSQLを使わなかったのはなぜか
  * データの更新が多いため
  * 局所的にNoSQLを使うことも検討している

* サーバ選定の理由や苦労した話
  * ベンチャーのため、サーバの運用にリソースが割けないのでクラウドで素早くリソース増減ができる
  * 技術者が足りていない

* データ取得について
  * 加速度センサは反応が遅れてくるので誤差が大きくなる
  * デバイスからのOBDによるデータの方が正確
    * 今後はデータを分析してスマホだけで判定できるようにしていきたい  

* IoTに関して法律の規制に関して苦労した点
  * 電波法
  * 自動車メーカがデータ取らせないようにしていたり
    * プラットフォームを提供することがビジネスの目的なのでデータ自体はなんでも良いと思っているので問題ない

* やばいと思ったこと
  * CANの知識を持っていたので簡単にできるんじゃないと思ったが、アクサ損保のキーパーソンの人の車種だけが不具合発生したり実際にプロダクトにするのは大変だった
  * 対応車種増やすためにレンタカー借りたり、パートナーと協力したり右往左往した
  * サーバについては、ハードの仕様変更は難しいので、急な仕様の変更などはサーバで対応する必要
  * iOSについてはCoreBlueToothを使っているが、無線なので切れてしまうことが必ずある
      * そのときに不具合の原因がOSのレベルなのか、ハードの問題なのか、アプリの問題なのかがわからず迷宮入りすることが多く困ることがおおかった

## 出てきた用語について調べた

* OBD：車両情報のこのことらしいです
　http://qiita.com/naohikowatanabe/items/39f14aacb06d04253d17  

* CAN：車載制御機器間のネットワークのプロトコルのようです  
  http://monoist.atmarkit.co.jp/mn/articles/0805/09/news152.html  

* Amazon Kinesis：大規模なストリーミングデータをリアルタイムで処理する完全マネージド型サービスだそうです
　http://dev.classmethod.jp/cloud/aws/what-is-kinesis/

* 電波法  
 http://news.mynavi.jp/series/wireless_embedded/004/
