# Auto Layoutのアルゴリズム

AutoLayoutは「制約」によるUIのレイアウト計算
## AutoLayoutをコードで書く場合
* 以下の3つの書き方がある
  * NSLayoutConstraint
  * Visual Format
  * NALayoutAnchor  

* NSLayoutAnchorを使うと分かりやすく書ける
* 個人的にはサードパーティのライブラリを使うことを推奨する

* レイアウト属性+関係性

## AutoLayoutの特徴
* 制約を宣言的に書くことができる
* 定義の順番は関係しない
* ビューの階層に依存しない制約をつけることができる
* 不等式、優先度、固有サイズ、収縮性・膨張性

## AutoLayoutのアルゴリズム
* ひとつの制約は以下の方程式で定義される  
属性1  = 係数 × 属性2 + 定数  
x1 = ax2 + b

* レイアウトを決定するには、全ての制約から作った行列の式を計算すれば良いか？  
Ax = b  


そんな単純じゃない
* AutoLayoutは等式だけでなく、不等式も扱う
* 優先度があるため、必ず、等式、不等式が成立しなくても良い
* 優先度の高い順に、なるべく多くの制約を満たすようにレイアウトを最適化する（=最適化問題）

最適化問題を線形計画問題として解く
* 与えられた線形な制約のもとで線形な目的関数を最大化あるいは最小化する

解決法はいろいろあるが、  
AutoLayoutアルゴリズムに求められるもの
* インタラクティブなUIアプリケーションを作る上で、高速なパフォーマンスは欠かせない  
-> シンプレックス法を採用

## Cassowary
* UIのための制約プログラミング手法
* SmallTalk/C++/Java/JavaScript/Python/Cocoaなどで実装されている
* AutoLayoutでも使われているアルゴリスム
* 1997年の論文内で発表されたもの  
https://constraints.cs.washington.edu/solvers/uist97.pdf

### シンプレックス法

1. 与えられた線形計画問題にスラック変数を導入して、標準形に直す
2. 実行可能基底解となる端点を出発点に選ぶ
3. 端点間をピボット操作で移動し、目的関数を改善する
4. 最適解となる端点が求まる  

解けないケースがある
* 実行可能解が存在しない
* 非有界（目的解が無限に存在する）

-> その場合は以下の方法で解く
* 2段階シンプレックス法
* 双体シンプレックス法

### Swift版Cassowary
1. シンプレックス法の適用
  * レイアウト属性は一般に非負条件がないのでそのままでは適用できない
2. 制約の差分更新（追加）
3. 制約の差分更新（削除）
4. 優先度の扱い
5. 「変数1つの値の変化」について差分更新

# まとめ
* Cassowaryを理解するのは一見難しく見える
* 足し算・掛け算・簡単な行列操作のみなので、高校数学の知識があれば、十分理解できる
* むしろ、英語中心の論文や情報を読む方が大変

* Cassowaryは変数を「好きなだけ」制約に使うことができる
* AutoLayoutは「2つの属性」の関係性のみなので、自らの可能性を制約している！

https://github.com/inamiy/Cassowary
